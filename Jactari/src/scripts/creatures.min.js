/* 
	Created by Jactari
	Updated by Aspirin and Aendawyn
	Maintained by Aendawyn

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
*/

$(document).ready(function(){
    function cherche_faction(nom){
        var trouvee=false;
        if(nom==_traduction.neutre[_langue])return-1;
        for(var f in _factions){
            if(_factions[f].nom[_langue]==nom){
                trouvee=true;
                break
            }
        }
        if(trouvee)return f;
        return false
    }
    function cherche_creature(nom,faction){
        var trouve=false;
        for(var u in _unites){
            if(_unites[u].nom[_langue]==nom&&_unites[u].faction==faction){
                trouve=true;
                break
            }
        }
        if(trouve)return u;
        return false
    }
    function tri_faction(a,b){
        return(a.faction-b.faction)
    }
    function tri_rang(a,b){
        return((a.rang*10+a.plus)-(b.rang*10+b.plus))
    }
    function tri_puissance(a,b){
        return(a.puissance-b.puissance)
    }
    function tri_cout(a,b){
        var cout_a=(a.cout!==undefined)?a.cout.G:0;
        var cout_b=(b.cout!==undefined)?b.cout.G:0;
        cout_a+=a.cout_special*cout_rare;
        cout_b+=b.cout_special*cout_rare;
        return(cout_a-cout_b)
    }
    function tri_rentabilite(a,b){
        if(a.cout===undefined||b.cout===undefined)return 0;
        var cout_a=a.cout_special*cout_rare;
        if(a.cout.G!==undefined)cout_a+=a.cout.G;
        var cout_b=b.cout_special*cout_rare;
        if(b.cout.G!==undefined)cout_b+=b.cout.G;
        var rentabilite_a=a.puissance/cout_a;
        var rentabilite_b=b.puissance/cout_b;
        return(rentabilite_a-rentabilite_b);
    }
    function tri_experience(a,b){
        return(a.experience-b.experience);
    }
    function tri_production(a,b){
        return(a.prod-b.prod);
    }
    function tri_id(a,b){
        return(a.id-b.id);
    }
    function tri_arme(a,b){
        return strcmp(a.arme,b.arme);
    }
    function tri_nom(a,b){
        return strcmp(a.nom[_langue],b.nom[_langue]);
    }
    function tri_creatures(tri,filtre){
        clone_unites(filtre);
        if(tri===undefined||tri==false||tri=='id')creatures.sort(tri_id);
        if(tri=='faction')creatures.sort(tri_faction);
        if(tri=='rang')creatures.sort(tri_rang);
        if(tri=='puissance')creatures.sort(tri_puissance);
        if(tri=='arme')creatures.sort(tri_arme);
        if(tri=='cout')creatures.sort(tri_cout);
        if(tri=='rentabilite')creatures.sort(tri_rentabilite);
        if(tri=='experience')creatures.sort(tri_experience);
        if(tri=='production')creatures.sort(tri_production);
        if(tri=='nom')creatures.sort(tri_nom);
        return true
    }
    function affiche_cout_complet(creature){
        var html='';
        for(var r in _ressources)if(creature.cout[r]!==undefined&&creature.cout[r]>0){
            if(html!='')html+=' ';
            html+=formate_nombre(creature.cout[r],0)+' '+image_html_ressource(r)
        }
        return html
    }
    function affiche_cout(cout){
        var html='';
        if(cout===undefined)return html;
        for(var r in _ressources)if(cout[r]!==undefined){
            if(html!='')html+=' ';
            html+=formate_nombre(cout[r],0)+' '+image_html_ressource(r)
        }
        return html
    }
    function liste_creatures(filtre,tri){
        var nombre=0;
        tri_creatures(tri,filtre);
        $('#liste-creatures').html(entete_tableau+'<tbody></tbody>');
        if(tri)$('th#entete-'+tri).addClass('critere');
        for(var c in creatures){
            var creature=creatures[c];
            if(!armes_siege&&creature.rang==0)continue;
            nombre++;
            if(creature.nom[_langue]==='')var nom='ï¿½ '+_traduction.nom_inconnu[_langue];else var nom=creature.nom[_langue];
            var faction = '';
            if (creature.faction == -1) {
                faction = _traduction.neutre[_langue];
            } else if (creature.faction == -2) {
                faction = _traduction.faction_new[_langue];
            } else {
                faction = _factions[creature.faction].nom[_langue];
            }
            var rang=((creature.rang>0)?creature.rang:'')+((creature.plus==1)?'+':'');
            var arme=_armes[creature.arme][_langue];
            if(creature.cout!==undefined){
                var cout_total=creature.cout_special*cout_rare;
                if(creature.cout.G!==undefined)cout_total+=creature.cout.G;
                var rentabilite=creature.puissance/cout_total;
                rentabilite=formate_nombre(rentabilite,2)
            }else var rentabilite='';
            var rangee='<tr id="creature-'+c+'"'+((nombre%2)?' class="impair"':'')+'>';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+faction+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="icone">'+image_html_troupe(creature.id,1)+'</td>';
            rangee+='<td class="arme">'+image_html_arme(creature.arme,0)+'</td>';
            rangee+='<td class="rang">'+rang+'</td>';
            //rangee+='<td class="faction"><a href="'+_base_url+_page+'/'+faction+'">'+faction+'</a></td>';
            rangee+='<td class="faction">'+faction+'</td>';
            rangee+='<td class="puissance">'+formate_puissance(creature.puissance)+'</td>';
            rangee+='<td class="cout">'+affiche_cout(creature.cout)+'</td>';
            rangee+='<td class="cout">'+affiche_cout(creature.cout_amel)+'</td>';
            rangee+='<td class="rentabilite">'+((creature.prod!==undefined)?creature.prod:'')+'</td>';
            rangee+='<td class="rentabilite">'+rentabilite+'</td>';
            rangee+='<td class="experience">'+formate_nombre(creature.experience,2)+'</td>';
            rangee+='</tr>';
            $('#liste-creatures tbody').append(rangee);
            if(description)$('#liste-creatures tbody').append('<tr'+((nombre%2)?' class="impair"':'')+'><td colspan="11" class="description">'+creature.description[_langue]+'</td></tr>')
        }
        var titre='<caption>'+nombre+' '+_traduction.creatures[_langue];
        if(filtre!==undefined&&filtre.rang!==undefined&&filtre.rang>0)titre+=' '+_traduction.de_rang[_langue]+' '+$('#filtre-rang option:selected').text();
        if(filtre!==undefined&&filtre.faction!==undefined&&filtre.faction!='')titre+=' '+_traduction.de_faction[_langue]+' '+$('#filtre-faction option:selected').text();
        if(filtre!==undefined&&filtre.arme!==undefined&&filtre.arme!=='')titre+=' '+_traduction.d_arme[_langue]+' '+$('#filtre-arme option:selected').text();
        titre+='</caption>';
        $('#liste-creatures').prepend(titre);
        $('#liste-creatures').addClass('general');
        if(_faction!==null){
            $('ul#choix-langue li a').each(function(id){
                var choix=$('ul#choix-langue li a').get(id);
                var langue_alt=$(choix).attr('hreflang');
                var lien=$(choix).attr('href');
                if (_faction == _traduction.neutre[_langue]) {
                    var faction_lien = _traduction.neutre[langue_alt];
                } else if (_faction == _traduction.faction_new[_langue]) {
                    var faction_lien = _traduction.neutre[langue_alt];
                } else {
                    var faction_lien = _factions[cherche_faction(_faction)].nom[langue_alt];
                }
                $(choix).attr('href',lien+'/'+faction_lien)
            })
        }
    }
    function affiche_creature(id){
        tri_creatures({
            id:true
        });
        var creature=creatures[id];
        $('#liste-creatures').html(entete_tableau+'<tbody></tbody>');
        if(creature!==undefined){
            if(creature.nom[_langue]==='')var nom='~'+_traduction.nom_inconnu[_langue]+'~';else var nom=creature.nom[_langue];
            if(creature.faction==-1)var faction=_traduction.neutre[_langue];else var faction=_factions[creature.faction].nom[_langue];
            var rang=((creature.rang>0)?creature.rang:'')+((creature.plus==1)?'+':'');
            var arme=_armes[creature.arme][_langue];
            if(creature.cout!==undefined){
                var cout_total=creature.cout_special*cout_rare;
                if(creature.cout.G!==undefined)cout_total+=creature.cout.G;
                var rentabilite=creature.puissance/cout_total;
                rentabilite=formate_nombre(rentabilite,2)
            }else var rentabilite='';
            var rangee='<tr id="creature-'+creature.id+'" class="impair">';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+faction+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="icone">'+image_html_troupe(creature.id,1)+'</td>';
            rangee+='<td class="arme">'+image_html_arme(creature.arme,0)+'</td>';
            rangee+='<td class="rang">'+rang+'</td>';
            //rangee+='<td class="faction"><a href="'+_base_url+_page+'/'+faction+'">'+faction+'</a></td>';
            rangee+='<td class="faction">'+faction+'</td>';
            rangee+='<td class="puissance">'+formate_puissance(creature.puissance)+'</td>';
            rangee+='<td class="cout">'+affiche_cout(creature.cout)+'</td>';
            rangee+='<td class="cout">'+affiche_cout(creature.cout_amel)+'</td>';
            rangee+='<td class="rentabilite">'+((creature.prod!==undefined)?creature.prod:'')+'</td>';
            rangee+='<td class="rentabilite">'+rentabilite+'</td>';
            rangee+='<td class="experience">'+formate_nombre(creature.experience,2)+'</td>';
            rangee+='</tr>';
            $('#liste-creatures tbody').append(rangee);
            $('#liste-creatures tbody').append('<tr class="impair"><td colspan="11" class="description">'+creature.description[_langue]+'</td></tr>');
            $('ul#choix-langue li a').each(function(id){
                var choix=$('ul#choix-langue li a').get(id);
                var langue_alt=$(choix).attr('hreflang');
                var lien=$(choix).attr('href');
                if(creature.faction==-1)var faction_lien=_traduction.neutre[langue_alt];else var faction_lien=_factions[creature.faction].nom[langue_alt];
                $(choix).attr('href',lien+'/'+faction_lien+'/'+creature.nom[langue_alt])
            })
        }else{
            $('#liste-creatures').append('<tr><td colspan="10">'+_traduction.id_creature_incorrect[_langue]+'</td></tr>')
        }
    }
    {
        var html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var f in _factions){
            html+='<option value="'+f+'"'+((_faction!==null&&_faction==_factions[f].nom[_langue])?' selected="selected"':'')+'>'+_factions[f].nom[_langue]+'</option>'
        }
        html+='<option value="-1"'+((_faction!==null&&_faction==_traduction.neutre[_langue])?' selected="selected"':'')+'>'+_traduction.neutre[_langue]+'</option>';
        html+='<option value="-2"'+((_faction!==null&&_faction==_traduction.faction_new[_langue])?' selected="selected"':'')+'>'+_traduction.faction_new[_langue]+'</option>';
        $('#filtre-faction').html(html);
        html='';
        html+='<option value="0">'+_traduction.quelconque[_langue]+'</option>';
        for(var n=1;n<8;n++){
            html+='<option value="'+n+'">'+n+'</option>'
        }
        $('#filtre-rang').html(html);
        html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var a in _armes){
            html+='<option value="'+a+'">'+_armes[a][_langue]+'</option>'
        }
        $('#filtre-arme').html(html);
        $('input[type=checkbox]').removeAttr('checked');
        $('#conteneur form').submit(function(){
            return false
        })
    }
    $('#javascript-desactive').addClass('cache');
    $('#conteneur').removeClass('cache');
    $('#version').html('version '+_version.v+' ('+_version.date+')');
    function filtre(critere){
        var filtre={};

        filtre.faction=$('#filtre-faction').val();
        filtre.rang=parseInt($('#filtre-rang').val(),10);
        filtre.arme=$('#filtre-arme').val();
        var tri=false;
        if(critere!==undefined)tri=critere;
        if($('#affichage-description').attr('checked'))description=true;else description=false;
        if($('#affichage-armes-siege').attr('checked'))armes_siege=true;else armes_siege=false;
        cout_rare=parseInt($('#cout-ressource-rare').val());
        liste_creatures(filtre,tri)
    }
    $('#filtrer,#ordonner').click(function(){
        filtre();
    });
    $('#filtre-rang,#filtre-arme,input[type=checkbox]').bind('change keyup',function(){
        filtre();
    });
    $('#filtre-faction').bind('change keyup',function(){
        var f = $(this).val();
        if (f == '') {
            f = '';
        } else if (f == -1) {
            f ='/'+_traduction.neutre[_langue];
        } else if (f == -2) {
            f = '/'+_traduction.faction_new[_langue];
        } else {
            f = '/'+_factions[f].nom[_langue];
        }
        filtre();
        //document.location.replace(_base_url+_page+f)
    });
    $('#liste-creatures th[id|="entete"]').live('click',function(){
        filtre($(this).attr('id').substr(7))
    });
    var description=false;
    var armes_siege=false;
    var cout_rare=1000;
    var entete_tableau='<thead><tr><th id="entete-nom">'+toCapitalCase(_traduction.nom[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.aspect[_langue])+'</th>'+'<th id="entete-arme">'+toCapitalCase(_traduction.arme[_langue])+'</th>'+'<th id="entete-rang">'+toCapitalCase(_traduction.rang[_langue])+'</th>'+'<th id="entete-faction">'+toCapitalCase(_traduction.faction[_langue])+'</th>'+'<th id="entete-puissance">'+toCapitalCase(_traduction.puissance[_langue])+'</th>'+'<th id="entete-cout">'+toCapitalCase(_traduction.cout[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.amelioration[_langue])+'</th>'+'<th id="entete-production">'+toCapitalCase(_traduction.production[_langue])+'</th>'+'<th id="entete-rentabilite">'+toCapitalCase(_traduction.rentabilite[_langue])+'</th>'+'<th id="entete-experience">'+toCapitalCase(_traduction.experience[_langue])+'</th></tr></thead>';
    var creatures=[];
    function clone_unites(filtre){
        creatures=[];
        for(var u in _unites){
            if(filtre!==undefined&&filtre.faction!==undefined&&filtre.faction!=''&&_unites[u].faction!=filtre.faction)continue;
            if(filtre!==undefined&&filtre.rang!==undefined&&filtre.rang>0&&_unites[u].rang!=filtre.rang)continue;
            if(filtre!==undefined&&filtre.arme!==undefined&&filtre.arme!==''&&_unites[u].arme!=filtre.arme)continue;
            {
                creatures[u]={
                    id:u,
                    nom:{
                        fr:_unites[u].nom.fr,
                        en:_unites[u].nom.en,
                        de:_unites[u].nom.de,
                        ru:_unites[u].nom.ru
                    },
                    faction:_unites[u].faction,
                    icone:_unites[u].icone,
                    rang:_unites[u].rang,
                    plus:_unites[u].plus,
                    arme:_unites[u].arme,
                    puissance:_unites[u].puissance,
                    ratio_xp:_unites[u].ratio_xp,
                    prod:_unites[u].prod,
                    description:{
                        fr:_unites[u].description.fr,
                        en:_unites[u].description.en,
                        de:_unites[u].description.de,
                        ru:_unites[u].description.ru
                    }
                };

                if(_unites[u].cout!==undefined){
                    creatures[u].cout={};

                    if(_unites[u].cout.G!==undefined)creatures[u].cout.G=_unites[u].cout.G;
                    var cout_special=0;
                    if(_unites[u].cout.c!==undefined){
                        cout_special+=_unites[u].cout.c;
                        creatures[u].cout.c=_unites[u].cout.c
                    }
                    if(_unites[u].cout.g!==undefined){
                        cout_special+=_unites[u].cout.g;
                        creatures[u].cout.g=_unites[u].cout.g
                    }
                    if(_unites[u].cout.m!==undefined){
                        cout_special+=_unites[u].cout.m;
                        creatures[u].cout.m=_unites[u].cout.m
                    }
                    if(_unites[u].cout.s!==undefined){
                        cout_special+=_unites[u].cout.s;
                        creatures[u].cout.s=_unites[u].cout.s
                    }
                    creatures[u].cout_special=cout_special
                }else creatures[u].cout_special=0;
                if(_unites[u].cout_amel!==undefined){
                    creatures[u].cout_amel={};

                    if(_unites[u].cout_amel.G!==undefined)creatures[u].cout_amel.G=_unites[u].cout_amel.G;
                    if(_unites[u].cout_amel.c!==undefined){
                        creatures[u].cout_amel.c=_unites[u].cout_amel.c
                    }
                    if(_unites[u].cout_amel.g!==undefined){
                        creatures[u].cout_amel.g=_unites[u].cout_amel.g
                    }
                    if(_unites[u].cout_amel.m!==undefined){
                        creatures[u].cout_amel.m=_unites[u].cout_amel.m
                    }
                    if(_unites[u].cout_amel.s!==undefined){
                        creatures[u].cout_amel.s=_unites[u].cout_amel.s
                    }
                }
                var experience=_unites[u].puissance/_unites[u].ratio_xp;
                creatures[u].experience=experience
            }
        }
    }
    var get=document.location.search;
    var pos=get.indexOf('id=');
    if(pos!=-1){
        var id=get.substr(pos+3);
        affiche_creature(id)
    }else if(_faction!==null&&_creature!==null){
        var f=cherche_faction(_faction);
        if(f!==false){
            var id=cherche_creature(_creature,f);
            if(id!==false)affiche_creature(id);else $('#conteneur').append(_traduction.creature_inconnue[_langue])
        }else{
            $('#conteneur').append(_traduction.faction_inconnue[_langue])
        }
    }else if(_faction!==null){
        var f=cherche_faction(_faction);
        if(f!==false){
            liste_creatures({
                faction:f
            })
        }else{
            $('#conteneur').append(_traduction.faction_inconnue[_langue])
        }
    }else{
        liste_creatures()
    }
    $.preloadImages(_images)
});