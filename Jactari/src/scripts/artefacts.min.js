/* 
	Created by Jactari
	Updated by Aspirin and Aendawyn
	Maintained by Aendawyn

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
*/

$(document).ready(function(){
    function cherche_faction(nom){
        var trouvee=false;
        if(nom==_traduction.commune[_langue])return-1;
        for(var f in _factions){
            if(_factions[f].nom[_langue]==nom){
                trouvee=true;
                break
            }
        }
        if(trouvee)return f;
        return false
    }
    function cherche_artefact(nom,faction){
        var trouve=false;
        for(var a in _artefacts){
            if(_artefacts[a].nom[_langue]==nom&&_artefacts[a].faction==faction){
                trouve=true;
                break
            }
        }
        if(trouve)return a;
        return false
    }
    function image_artefact(id){
        image_css_artefact('artefact-'+id+' td.icone img',id)
    }
    function strcmp(str1,str2){
        return((str1==str2)?0:((str1>str2)?1:-1))
    }
    function tri_faction(a,b){
        return(a.faction-b.faction)
    }
    function tri_niveau(a,b){
        return(a.niv-b.niv)
    }
    function tri_slot(a,b){
        return(a.slot-b.slot)
    }
    function tri_nom(a,b){
        return(strcmp(a.nom[_langue],b.nom[_langue]))
    }
    function tri_artefacts(tri){
        if(tri.faction!==undefined&&tri.faction==true)_artefacts.sort(tri_faction);
        if(tri.niveau!==undefined&&tri.niveau==true)_artefacts.sort(tri_niveau);
        if(tri.slot!==undefined&&tri.slot==true)_artefacts.sort(tri_slot);
        if(tri.nom!==undefined&&tri.nom==true)_artefacts.sort(tri_nom)
    }
    function liste_artefacts(filtre,tri) {
        var nombre = 0;
        $('#liste-artefacts').html(entete_tableau+'<tbody></tbody>');
        if(tri!==undefined)tri_artefacts(tri);
        for(var a in _artefacts) {
            var arte = _artefacts[a];
            if (filtre !== undefined && filtre.faction !== undefined && filtre.faction !='' && arte.faction != filtre.faction) {
                continue;
            }
            if (filtre !== undefined && filtre.niveau !== undefined && filtre.niveau > 0 && arte.niv != filtre.niveau) {
                continue;
            }
            if (filtre !== undefined && filtre.slot !== undefined && filtre.slot !== '') {
                if (arte.slot === '' || arte.slot != parseInt(filtre.slot)) {
                    continue;
                }
            }
            if (filtre !== undefined && filtre.effet !== undefined && filtre.effet !== '') {
                var effets_filtres = 0;
                for (var e in arte.effets){
                    effets_filtres += (!inArray(_types_effets[parseInt(filtre.effet)].effets,arte.effets[e].id))?0:1
                }
                if (effets_filtres < 1) {
                    continue
                }
            }
            if (filtre !== undefined) {
                if (filtre.set == '-2' && arte.set !== undefined) {
                    continue;
                }
                if (filtre.set == '0' && arte.set == undefined) {
                    continue;
                }
                if (parseInt(filtre.set) > 0) {
                    if (arte.set !== undefined && arte.set != parseInt(filtre.set)) {
                            continue;
                    }
                    if (arte.set == undefined) {
                        continue;
                    }
                }
            }
            if (arte.faction !== '') {
                if (arte.nom[_langue] === '') {
                    var nom = '~'+_traduction.nom_inconnu[_langue]+'~';
                } else {
                    var nom=arte.nom[_langue];
                }
                if (arte.faction == -1) {
                    var faction=_traduction.commune[_langue];
                } else {
                    var faction=_factions[arte.faction].nom[_langue];
                }
                var niveau=arte.niv;
                if (arte.slot === '') {
                    var slot = '?';
                } else {
                    var slot = _slots[arte.slot][_langue];
                }
                if (arte.type === '') {
                    var type = '?';
                } else {
                    var type = _types_artefacts[arte.type][_langue];
                }
                var set = '';
                if (typeof arte.set != 'undefined') {
                    set = _sets_artefacts[arte.set].nom[_langue];
                }
                var effets = '';
                var niveau_reel = 0;
                for (var e in arte.effets) {
                    var effet=_effets[arte.effets[e].id];
                    var valeur=effet.v[arte.effets[e].niv-1];
                    niveau_reel+=arte.effets[e].niv;
                    effets+=effet.description[_langue].replace(/X/,'<span class="valeur-effet">'+valeur+'</span>')+'<br />'
                }
                var rangee='<tr id="artefact-'+a+'">';
                //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+faction+'/'+nom+'">'+nom+'</a></td>';
                rangee+='<td class="nom">'+nom+'</td>';
                rangee+='<td class="icone"><img src="'+_base_url+'images/unite.png" alt="icône" /></td>';
                rangee+='<td class="faction"><abbr title="'+faction+'">'+faction.substr(0,1)+'</abbr></td>';
                if(arte.niv!=niveau_reel)niveau+=' ['+niveau_reel+']';
                rangee+='<td class="niveau">'+niveau+'</td>';
                rangee+='<td class="slot">'+slot+'</td>';
                rangee+='<td class="type">'+type+'</td>';
                rangee+='<td class="set">'+set+'</td>';
                rangee+='<td class="effets">'+effets+'</td>';
                rangee+='</tr>';
                $('#liste-artefacts tbody').append(rangee);
                image_artefact(a);
                nombre++
            }
        }
        var titre='<caption>'+_traduction.artefacts[_langue];
        if(filtre!==undefined&&filtre.niveau!==undefined&&filtre.niveau>0)titre+=' '+_traduction.de_niveau[_langue]+' '+$('#filtre-niveau option:selected').text();
        if(filtre!==undefined&&filtre.faction!==undefined&&filtre.faction!='')titre+=' '+_traduction.de_faction[_langue]+' '+$('#filtre-faction option:selected').text();
        if(filtre!==undefined&&filtre.slot!==undefined&&filtre.slot!=='')titre+=' '+_traduction.d_emplacement[_langue]+' '+$('#filtre-slot option:selected').text();
        if(filtre!==undefined&&filtre.effet!==undefined&&filtre.effet!=='')titre+=' '+_traduction.ayant_effet[_langue]+' '+$('#filtre-effet option:selected').text();
        titre+=' ('+nombre+')</caption>';
        $('#liste-artefacts').addClass('general');
        $('#liste-artefacts').prepend(titre)
    }
    function affiche_artefact(id){
        var arte=_artefacts[id];
        $('#liste-artefacts').html(entete_tableau+'<tbody></tbody>');
        if(arte!==undefined&&arte.faction!==''){
            if(arte.nom[_langue]==='')var nom='~'+_traduction.nom_inconnu[_langue]+'~';else var nom=arte.nom[_langue];
            if(arte.faction==-1)var faction=_traduction.commune[_langue];else var faction=_factions[arte.faction].nom[_langue];
            var niveau=arte.niv;
            if(arte.slot==='')var slot='?';else var slot=_slots[arte.slot][_langue];
            if(arte.type==='')var type='?';else var type=_types_artefacts[arte.type][_langue];
            var effets='';
            var niveau_reel=0;
            for(var e in arte.effets){
                var effet=_effets[arte.effets[e].id];
                var valeur=effet.v[arte.effets[e].niv-1];
                niveau_reel+=arte.effets[e].niv;
                effets+=effet.description[_langue].replace(/X/,'<span class="valeur-effet">'+valeur+'</span>')+'<br />'
            }
            var rangee='<tr id="artefact-'+id+'">';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="icone"><img src="'+_base_url+'images/unite.png" alt="icône" /></td>';
            rangee+='<td class="faction"><abbr title="'+faction+'">'+faction.substr(0,1)+'</abbr></td>';
            if(arte.niv!=niveau_reel)niveau+=' ['+niveau_reel+']';
            rangee+='<td class="niveau">'+niveau+'</td>';
            rangee+='<td class="slot">'+slot+'</td>';
            rangee+='<td class="type">'+type+'</td>';
            rangee+='<td class="effets">'+effets+'</td>';
            rangee+='</tr>';
            $('#liste-artefacts tbody').append(rangee);
            image_artefact(id);
            $('ul#choix-langue li a').each(function(id){
                var choix=$('ul#choix-langue li a').get(id);
                var langue_alt=$(choix).attr('hreflang');
                var lien=$(choix).attr('href');
                if(arte.faction==-1)var faction_lien=_traduction.commune[langue_alt];else var faction_lien=_factions[arte.faction].nom[langue_alt];
                $(choix).attr('href',lien+'/'+faction_lien+'/'+arte.nom[langue_alt])
            })
        }
        else{
            $('#liste-artefacts tbody').append('<tr><td colspan="7">'+_traduction.id_artefact_incorrect[_langue]+'</td></tr>')
        }
    }
    {
        var html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        html+='<option value="-1">'+_traduction.commune[_langue]+'</option>';
        for(var f in _factions){
            html+='<option value="'+f+'">'+_factions[f].nom[_langue]+'</option>'
        }
        $('#filtre-faction').html(html);
        html='';
        html+='<option value="0">'+_traduction.quelconque[_langue]+'</option>';
        for(var n=1;n<9;n++){
            html+='<option value="'+n+'">'+n+'</option>'
        }
        $('#filtre-niveau').html(html);
        html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var s in _slots){
            html+='<option value="'+s+'">'+_slots[s][_langue]+'</option>'
        }
        $('#filtre-slot').html(html);
        html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for (var e in _types_effets) {
            html += '<option value="' + e + '">' + _types_effets[e].description[_langue] + '</option>';
        }
        $('#filtre-effet').html(html);

        html = '';
        html += '<option value="-1"></option>';
        html += '<option value="-2">' + _traduction.aucun[_langue] + '</option>';
        for (var set in _sets_artefacts) {
            if (set == 0) {
                html += '<option value="' + set + '">' + _traduction.quelconque[_langue] + '</option>';
            } else {
                html += '<option value="' + set + '">' + _sets_artefacts[set].nom[_langue] + '</option>';
            }
        }
        $('#filtre-set').html(html);
        $('input[type=checkbox]').removeAttr('checked');
        $('#conteneur form').submit(function(){
            return false;
        })
    }
    javascript_active();

    $('#saison').change(function() {
        var nouvelle_saison = controle_saison();
        var saison = $('#saison').val();
        if(typeof id!='undefined')affiche_artefact(id);else filtre()
    });
    function filtre() {
        var filtre={};

        var tri={};

        filtre.faction = $('#filtre-faction').val();
        filtre.niveau = parseInt($('#filtre-niveau').val(),10);
        filtre.slot = $('#filtre-slot').val();
        filtre.effet = $('#filtre-effet').val();
        filtre.set = $('#filtre-set').val();
        tri.faction = ($('#tri-faction').attr('checked'));
        tri.niveau = ($('#tri-niveau').attr('checked'));
        tri.slot = ($('#tri-slot').attr('checked'));
        tri.nom = ($('#tri-nom').attr('checked'));
        liste_artefacts(filtre, tri)
    }
    $('#filtrer,#ordonner').click(function() {
        filtre();
    });
    $('#filtres select, #tris input[type=checkbox]').bind('change keyup',function() {
        filtre();
    });
    var entete_tableau = '<thead><tr><th>' + toCapitalCase(_traduction.nom[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.aspect[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.faction[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.niveau[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.emplacement[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.type[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.set[_langue]) + '</th>'
    + '<th>' + toCapitalCase(_traduction.description[_langue])+'</th>'
    + '</tr></thead>';
    var get=document.location.search;
    var pos=get.indexOf('id=');
    if(pos!=-1){
        var id=get.substr(pos+3);
        affiche_artefact(id)
    }else if(_faction!==null&&_artefact!==null){
        var f=cherche_faction(_faction);
        if(f!==false){
            var id=cherche_artefact(_artefact,f);
            if(id!==false)affiche_artefact(id);else $('#conteneur').append(_traduction.artefact_inconnu[_langue])
        }else{
            $('#conteneur').append(_traduction.faction_inconnue[_langue])
        }
    }else{
        liste_artefacts()
    }
    $.preloadImages(_images)
});