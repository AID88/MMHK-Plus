/* 
	Created by Jactari
	Updated by Aspirin and Aendawyn
	Maintained by Aendawyn

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
*/

$(document).ready(function(){
    function cherche_ecole(nom){
        var trouvee=false;
        for(var e in _ecoles_magie){
            if(_ecoles_magie[e].nom[_langue]==nom){
                trouvee=true;
                break
            }
        }
        if(trouvee)return e;
        return false
    }
    function cherche_sort(nom,ecole){
        var trouve=false;
        for(var s in _sorts){
            if(_sorts[s].nom[_langue]==nom&&_sorts[s].ecole==ecole){
                trouve=true;
                break
            }
        }
        if(trouve)return s;
        return false;
    }
    function factions_ecole(ecole,langue){
        var factions='';
        var nb_factions=0;
        for(var f in _factions){
            var nom_faction=_factions[f].nom[langue];
            if(inArray(_factions[f].ecoles,ecole)){
                if(nb_factions>0)factions+=', ';
                factions+='<abbr title="'+nom_faction+'">'+nom_faction.substr(0,1)+'</abbr>';
                nb_factions++
            }
        }
        return factions
    }
    function tri_ecole(a,b){
        return(a.ecole-b.ecole)
    }
    function tri_cercle(a,b){
        return(a.cercle-b.cercle)
    }
    function tri_id(a,b){
        return(a.id-b.id)
    }
    function tri_type(a,b){
        return(a.type-b.type)
    }
    function tri_nom(a,b){
        return strcmp(a.nom[_langue],b.nom[_langue])
    }
    function tri_sorts(tri){
        if(tri===undefined)return;
        if(tri.ecole!==undefined&&tri.ecole==true)sorts.sort(tri_ecole);
        if(tri.cercle!==undefined&&tri.cercle==true)sorts.sort(tri_cercle);
        if(tri.type!==undefined&&tri.type==true)sorts.sort(tri_type);
        if(tri.nom!==undefined&&tri.nom==true)sorts.sort(tri_nom);
        if(tri.id!==undefined&&tri.id==true)sorts.sort(tri_id)
    }
    function liste_sorts(filtre,tri){
        var nombre=0;
        tri_sorts(tri);
        $('#liste-sorts').html(entete_tableau+'<tbody></tbody>');
        for(var s in sorts){
            var sort_=sorts[s];
            if(filtre!==undefined&&filtre.ecole!==undefined&&filtre.ecole<4&&sort_.ecole!=filtre.ecole)continue;
            if(filtre!==undefined&&filtre.faction!==undefined&&filtre.faction!=''&&!inArray(_factions[filtre.faction].ecoles,sort_.ecole))continue;
            if(filtre!==undefined&&filtre.cercle!==undefined&&filtre.cercle>0&&sort_.cercle!=filtre.cercle)continue;
            if(filtre!==undefined&&filtre.type!==undefined&&filtre.type<5&&sort_.type!=filtre.type)continue;
            nombre++;
            if(sort_.nom[_langue]==='')var nom='ï¿½'+_traduction.nom_inconnu[_langue];else var nom=sort_.nom[_langue];
            var rangee='<tr id="sort-'+s+'"'+((nombre%2)?' class="impair"':'')+'>';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+_ecoles_magie[sort_.ecole].nom[_langue]+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="icone">'+image_html_sort(sort_.id)+'</td>';
            if(popularite)rangee+='<td class="pop">'+image_html_score(Math.round(sort_.stat*5/stats_maximum),5)+'</td>';
            rangee+='<td class="ecole">'+_ecoles_magie[sort_.ecole].nom[_langue]+'</td>';
            rangee+='<td class="faction">'+factions_ecole(sort_.ecole,_langue)+'</td>';
            rangee+='<td class="cercle">'+sort_.cercle+'</td>';
            rangee+='<td class="type">'+_types_sorts[sort_.type][_langue]+'</td>';
            rangee+='<td class="cout">'+sort_.cible+'</td>';
            if(sort_.type==1){
            var arme=inArrayIndex(sort_.facteur,1);
            rangee+='<td class="puissance" colspan="3">'+image_html_arme(arme,0,true)+' '+formate_nombre(sort_.facteur[arme]*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }else if(sort_.facteur.I!=sort_.facteur.R||sort_.facteur.R!=sort_.facteur.C){
                if(inArray([1,3],sort_.unite)){
                    var contre=-1;
                    var titre=_traduction.contre[_langue]+' X'
                }else{
                    var contre=1;
                    var titre=_traduction.sur_on[_langue]+' X'
                }
                rangee+='<td class="puissance">'+image_html_arme('I',contre,true,titre)+' '+formate_nombre(sort_.facteur.I*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>';
                rangee+='<td class="puissance">'+image_html_arme('R',contre,true,titre)+' '+formate_nombre(sort_.facteur.R*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>';
                rangee+='<td class="puissance">'+image_html_arme('C',contre,true,titre)+' '+formate_nombre(sort_.facteur.C*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }else{
                rangee+='<td class="puissance" colspan="3">'+formate_nombre(sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }
            rangee+='</tr>';
            $('#liste-sorts tbody').append(rangee);
            if(description){
                var puissance=sort_.puissance;
                if(puissance-Math.floor(puissance)!=0)puissance=formate_nombre(puissance,2,'proche',true);else puissance=formate_nombre(puissance,0);
                rangee='<tr'+((nombre%2)?' class="impair"':'')+'><td colspan="10" class="description">';
                rangee+=sort_.description[_langue].replace(/X/,puissance);
                rangee+='</td></tr>';
                $('#liste-sorts tbody').append(rangee)
            }
        }
        var titre='<caption>'+nombre+' '+_traduction.sorts[_langue];
        if(filtre!==undefined&&filtre.ecole!==undefined&&filtre.ecole<4)titre+=' '+_traduction.d_ecole[_langue]+' '+$('#filtre-ecole option:selected').text();
        if(filtre!==undefined&&filtre.cercle!==undefined&&filtre.cercle>0)titre+=' '+_traduction.de_cercle[_langue]+' '+$('#filtre-cercle option:selected').text();
        if(filtre!==undefined&&filtre.type!==undefined&&filtre.type<5)titre+=' '+_traduction.de_type[_langue]+' '+$('#filtre-type option:selected').text();
        titre+='</caption>';
        $('#liste-sorts').prepend(titre);
        $('#liste-sorts').addClass('general')
    }
    function affiche_sort(id){
        tri_sorts({
            id:true
        });
        var sort_=sorts[id];
        $('#liste-sorts').html(entete_tableau+'<tbody></tbody>');
        if(sort_!==undefined){
            if(sort_.nom[_langue]==='')var nom='~'+_traduction.nom_inconnu[_langue]+'~';else var nom=sort_.nom[_langue];
            var rangee='<tr id="sort-'+sort_.id+'" class="impair">';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+_ecoles_magie[sort_.ecole].nom[_langue]+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="icone">'+image_html_sort(sort_.id)+'</td>';
            rangee+='<td class="ecole">'+_ecoles_magie[sort_.ecole].nom[_langue]+'</td>';
            rangee+='<td class="faction">'+factions_ecole(sort_.ecole,_langue)+'</td>';
            rangee+='<td class="cercle">'+sort_.cercle+'</td>';
            rangee+='<td class="type">'+_types_sorts[sort_.type][_langue]+'</td>';
            rangee+='<td class="cout">'+sort_.cible+'</td>';
            if(sort_.type==1){
                var arme=inArrayIndex(sort_.facteur,1);
                rangee+='<td class="puissance" colspan="3">'+image_html_arme(arme,0,true)+' '+formate_nombre(sort_.facteur[arme]*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }else if(sort_.facteur.I!=sort_.facteur.R||sort_.facteur.R!=sort_.facteur.C){
                if(inArray([1,3],sort_.unite)){
                    var contre=-1;
                    var titre=_traduction.contre[_langue]+' X'
                }else{
                    var contre=1;
                    var titre=_traduction.sur_on[_langue]+' X'
                }
                rangee+='<td class="puissance">'+image_html_arme('I',contre,true,titre)+' '+formate_nombre(sort_.facteur.I*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>';
                rangee+='<td class="puissance">'+image_html_arme('R',contre,true,titre)+' '+formate_nombre(sort_.facteur.R*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>';
                rangee+='<td class="puissance">'+image_html_arme('C',contre,true,titre)+' '+formate_nombre(sort_.facteur.C*sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }else{
                rangee+='<td class="puissance" colspan="3">'+formate_nombre(sort_.puissance,3,'proche',true)+sort_.calcul+'</td>'
            }
            rangee+='</tr>';
            $('#liste-sorts tbody').append(rangee);
            var puissance=sort_.puissance;
            if(puissance-Math.floor(puissance)!=0)puissance=formate_nombre(puissance,2,'proche',true);else puissance=formate_nombre(puissance,0);
            rangee='<tr class="impair"><td colspan="10" class="description">';
            rangee+=sort_.description[_langue].replace(/X/,puissance);
            rangee+='</td></tr>';
            $('#liste-sorts tbody').append(rangee);
            $('ul#choix-langue li a').each(function(id){
                var choix=$('ul#choix-langue li a').get(id);
                var langue_alt=$(choix).attr('hreflang');
                var lien=$(choix).attr('href');
                var ecole_lien=_ecoles_magie[sort_.ecole].nom[langue_alt];
                $(choix).attr('href',lien+'/'+ecole_lien+'/'+sort_.nom[langue_alt])
            })
        }else{
            $('#liste-sorts').append('<tr><td colspan="10">'+_traduction.id_sort_incorrect[_langue]+'</td></tr>')
        }
    }
    function cookieGetValueByKey(key) {
        if (typeof $.cookie('jactari_cookie') != 'undefined') {
            try {
                var cookieData = JSON.parse($.cookie('jactari_cookie'));
            } catch(e) {
                $.cookie('jactari_cookie', '', {
                    expires: -1,
                    path: '/'
                });
                return {};
            }
            if (typeof key != 'undefined') {
                if (typeof cookieData[key] != 'undefined') {
                    return cookieData[key];
                }
            } else {
                return cookieData;
            }
        }
        return {};
    }
    // main
    {
        var html='';
        html+='<option value="4">'+_traduction.quelconque[_langue]+'</option>';
        for(var e in _ecoles_magie){
            html+='<option value="'+e+'">'+_ecoles_magie[e].nom[_langue]+'</option>'
        }
        $('#filtre-ecole').html(html);
        var html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var f in _factions){
            html+='<option value="'+f+'">'+_factions[f].nom[_langue]+'</option>'
        }
        $('#filtre-faction').html(html);
        html='';
        html+='<option value="0">'+_traduction.quelconque[_langue]+'</option>';
        for(var n=1;n<6;n++){
            html+='<option value="'+n+'">'+n+'</option>'
        }
        $('#filtre-cercle').html(html);
        html='';
        html+='<option value="5">'+_traduction.quelconque[_langue]+'</option>';
        for(var t in _types_sorts){
            html+='<option value="'+t+'">'+_types_sorts[t][_langue]+'</option>'
        }
        $('#filtre-type').html(html);
        $('input[type=checkbox]').removeAttr('checked');
        
        $('#conteneur form').submit(function(){
            return false
        })
    }
    $('#javascript-desactive').addClass('cache');
    $('#conteneur').removeClass('cache');
    //$('#version').html('version '+_version.v+' ('+_version.date+')');
    //$('#version').html(_traduction.version_jeu[_langue]+' '+_version.v+' ('+_version.date+')'+' <label for="saison">'+_traduction.saison[_langue]+'</label>'+'<select id="saison">'+'<option value="3">3</option>'+'<option value="4" selected="selected">4</option></select>');

    
    function filtre(){
        var filtre={};
        var tri={};
        filtre.ecole=parseInt($('#filtre-ecole').val());
        filtre.faction=$('#filtre-faction').val();
        filtre.cercle=parseInt($('#filtre-cercle').val());
        filtre.type=$('#filtre-type').val();
        
        var cookieData = cookieGetValueByKey();
        cookieData.spells_save = +($('#asp_save_spells').attr('checked'));
        cookieData.spells_school = filtre.ecole;
        cookieData.spells_faction = filtre.faction;
        cookieData.spells_level = filtre.cercle;
        cookieData.spells_type = filtre.type;
        $.cookie('jactari_cookie', JSON.stringify(cookieData), {
            expires: 30,
            path: '/'
        });

        tri.ecole=($('#tri-ecole').attr('checked'));
        tri.cercle=($('#tri-cercle').attr('checked'));
        tri.type=($('#tri-type').attr('checked'));
        tri.nom=($('#tri-nom').attr('checked'));
        if($('#affichage-description').attr('checked'))description=true;else description=false;
        if($('#affichage-popularite').attr('checked'))popularite=true;else popularite=false;
        liste_sorts(filtre,tri);
    }
    $('#filtrer,#ordonner').click(function(){
        filtre();
    });
    $('select,input[type=checkbox]').bind('change keyup',function(){
        filtre();
    });
    var description=false;
    var popularite=false;
    var entete_tableau='<thead><tr>'+'<th>'+toCapitalCase(_traduction.nom[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.aspect[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.ecole[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.faction[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.cercle[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.type[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.cible[_langue])+'</th>'+'<th colspan="3">'+toCapitalCase(_traduction.puissance[_langue])+'</th>'+'</tr></thead>';
    var entete_tableau_pop='<thead><tr>'+'<th>'+toCapitalCase(_traduction.nom[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.aspect[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.popularite[_langue])+'</th>'+'<th>'+_traduction.ecole[_langue]+'</th>'+'<th>'+toCapitalCase(_traduction.cercle[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.type[_langue])+'</th>'+'<th>'+toCapitalCase(_traduction.cible[_langue])+'</th>'+'<th colspan="3">'+toCapitalCase(_traduction.puissance[_langue])+'</th>'+'</tr></thead>';
    var sorts=[];
    var stats_sorts=[];
    var stats_maximum=0;
    clonage_liste_sorts();
    listage_sorts();
    affichage_version();
    $('#saison').change(function(){
        saveVersionInCookie();
        nouvelle_saison=controle_saison();
        saison=$('#saison').val();
        clonage_liste_sorts();
        listage_sorts();
    });
    
    if (typeof cookieGetValueByKey('spells_save') == 'number') {
        var asp_save = parseInt(cookieGetValueByKey('spells_save'),10);
        if (asp_save == 1) {
            $('#asp_save_spells').attr('checked','checked');
            $('#filtre-ecole').val(parseInt(cookieGetValueByKey('spells_school'),10));
            $('#filtre-faction').val(parseInt(cookieGetValueByKey('spells_faction'),10));
            $('#filtre-cercle').val(parseInt(cookieGetValueByKey('spells_level'),10));
            $('#filtre-type').val(parseInt(cookieGetValueByKey('spells_type'),10));
            filtre();
        }
    }
    function clonage_liste_sorts(){
        for(var s in _sorts){
            sorts[s]={
                id:s,
                stat:(stats_sorts[s]!==undefined)?stats_sorts[s]:0,
                nom:{
                    fr:_sorts[s].nom.fr,
                    en:_sorts[s].nom.en,
                    de:_sorts[s].nom.de,
                    ru:_sorts[s].nom.ru
                },
                ecole:_sorts[s].ecole,
                icone:_sorts[s].icone,
                cercle:_sorts[s].cercle,
                type:_sorts[s].type,
                cible:'',
                unite:_sorts[s].unite,
                facteur:{
                    I:_sorts[s].facteur.I,
                    R:_sorts[s].facteur.R,
                    C:_sorts[s].facteur.C
                },
                puissance:_sorts[s].puissance,
                description:{
                    fr:_sorts[s].description.fr,
                    en:_sorts[s].description.en,
                    de:_sorts[s].description.de,
                    ru:_sorts[s].description.ru
                }
            };

            if(_sorts[s].type==1)sorts[s].cible=_armes[_cibles_sorts[_sorts[s].cible].arme][_langue];
            if(_sorts[s].type==2)sorts[s].cible=_cibles_sorts[4][_langue];
            if(_sorts[s].type==0)sorts[s].cible=_cibles_sorts[_sorts[s].cible][_langue];
            if(_sorts[s].type==3){
                sorts[s].cible=_cibles_sorts[_sorts[s].cible][_langue];
                if(_sorts[s].cible==5||_sorts[s].cible==6)sorts[s].cible+=' '+_traduction.heros[_langue]
            }
            if(_sorts[s].type==4){
                sorts[s].cible=_cibles_sorts[_sorts[s].cible][_langue]+' '+_cibles_sorts[4][_langue]
            }
            if(inArray([2,3,4,6],_sorts[s].unite))sorts[s].calcul=_unites_sorts[2][_langue];else sorts[s].calcul=''
        }
    }
    function listage_sorts(){
        var get=document.location.search;
        var pos=get.indexOf('id=');
        if(pos!=-1){
            var id=get.substr(pos+3);
            affiche_sort(id)
        }else if(_ecole!==null&&_sort!==null){
            var e=cherche_ecole(_ecole);
            if(e!==false){
                var id=cherche_sort(_sort,e);
                if(id!==false)affiche_sort(id);else $('#conteneur').append(_traduction.sort_inconnu[_langue])
            }else{
                $('#conteneur').append(_traduction.ecole_inconnue[_langue])
            }
        }else{
            liste_sorts()
        }
    }
    $.preloadImages(_images)
});