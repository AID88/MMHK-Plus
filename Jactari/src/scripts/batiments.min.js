/* 
	Created by Jactari
	Updated by Aspirin and Aendawyn
	Maintained by Aendawyn

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
*/

$(document).ready(function(){
    function cherche_faction(nom){
        var trouvee=false;
        for(var f in _factions){
            if(_factions[f].nom[_langue]==nom){
                trouvee=true;
                break
            }
        }
        if(trouvee)return f;
        return false
    }
    function cherche_categorie(nom){
        var trouvee=false;
        for(var c in _categories_batiments){
            if(_categories_batiments[c].nom[_langue]==nom){
                trouvee=true;
                break
            }
        }
        if(trouvee)return c;
        return false
    }
    function cherche_batiment(nom,faction){
        var trouve=false;
        for(var b in _batiments){
            if(_batiments[b].nom[_langue]==nom&&_batiments[b].faction==faction){
                trouve=true;
                break
            }
        }
        if(trouve)return b;
        return false
    }
    function tri_faction(a,b){
        return(a.faction-b.faction)
    }
    function tri_categorie(a,b){
        return(a.categorie-b.categorie)
    }
    function tri_domination(a,b){
        return(a.domination-b.domination)
    }
    function tri_duree(a,b){
        return(a.duree-b.duree)
    }
    function tri_cout(a,b){
        var cout_a=a.cout.G;
        var cout_b=b.cout.G;
        for(var r in _ressources){
            if(a.cout[r]!==undefined){
                if(inArray(['w','o'],r))cout_a+=a.cout[r]*cout_commune;
                if(inArray(['c','g','m','s'],r))cout_a+=a.cout[r]*cout_rare
            }
            if(b.cout[r]!==undefined){
                if(inArray(['w','o'],r))cout_b+=b.cout[r]*cout_commune;
                if(inArray(['c','g','m','s'],r))cout_b+=b.cout[r]*cout_rare
            }
        }
        return(cout_a-cout_b)
    }
    function tri_id(a,b){
        return(a.id-b.id)
    }
    function tri_nom(a,b){
        return strcmp(a.nom[_langue],b.nom[_langue])
    }
    function tri_batiments(tri){
        if(tri===undefined)return;
        if(tri.faction!==undefined&&tri.faction==true)batiments.sort(tri_faction);
        if(tri.categorie!==undefined&&tri.categorie==true)batiments.sort(tri_categorie);
        if(tri.domination!==undefined&&tri.domination==true)batiments.sort(tri_domination);
        if(tri.duree!==undefined&&tri.duree==true)batiments.sort(tri_duree);
        if(tri.cout!==undefined&&tri.cout==true)batiments.sort(tri_cout);
        if(tri.nom!==undefined&&tri.nom==true)batiments.sort(tri_nom);
        if(tri.id!==undefined&&tri.id==true)batiments.sort(tri_id);
    }
    function affiche_cout_complet(batiment,mod){
        var html='';
        for(var r in _ressources)if(batiment.cout[r]!==undefined){
            if(html!='')html+=' ';
            html+='<td class="cout">'+formate_nombre(Math.ceil(batiment.cout[r]*multiplicateur_cout),0)+' '+image_html_ressource(r)+'</td>'
        }else{
            html+='<td class="cout"></td>'
        }
        return html
    }
    function liste_batiments(filtre,tri) {
        if (typeof filtre != 'undefined') {
            var cookieData = cookieGetValueByKey();
            cookieData.faction = filtre.faction;
            cookieData.categorie = filtre.categorie;
            $.cookie('jactari_cookie', JSON.stringify(cookieData), {
                expires: 30,
                path: '/'
            });
        }
        if (typeof $.cookie('jactari_cookie') != 'undefined') {
            filtre = {};
            filtre.faction = cookieGetValueByKey('faction');
            filtre.categorie = cookieGetValueByKey('categorie');
        }
        var nombre=0;
        tri_batiments(tri);
        $('#liste-batiments').html(entete_tableau+'<tbody></tbody>');
        
        for(var c in batiments){
            var batiment=batiments[c];
            if(filtre!==undefined&&filtre.faction!=''&&batiment.faction!=filtre.faction)continue;
            if(filtre!==undefined&&filtre.categorie!=''&&batiment.categorie!=filtre.categorie)continue;
            nombre++;
            if(batiment.nom[_langue]==='')var nom='~'+_traduction.nom_inconnu[_langue]+'~';else var nom=batiment.nom[_langue];
            if(batiment.faction==-1)var faction=_traduction.neutre[_langue];else var faction=_factions[batiment.faction].nom[_langue];
            if(batiment.prerequis.batiment===null)var prerequis='';else var prerequis=_batiments[batiment.prerequis.batiment].nom[_langue];
            var rangee='<tr id="batiment-'+c+'"'+((nombre%2)?' class="impair"':'')+'>';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+_factions[batiment.faction].nom[_langue]+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="faction">'+faction+'</td>';
            rangee+='<td class="categorie">'+_categories_batiments[batiment.categorie].nom[_langue]+'</td>';
            rangee+=affiche_cout_complet(batiment,modificateur_construction);
            var duration = Math.floor(batiment.duree*multiplicateur_duree*(1-(contremaitre/100)));
            var d = new Date();
            var e = new Date();
            e.setMinutes(e.getMinutes() + duration);
            e.setMinutes(e.getMinutes() + parseInt($('#asp_start_time_minutes').val()));
            var bTime = [
            d.getDate(),
            (d.getMonth() + 1),
            d.getFullYear(),
            d.getHours(),
            d.getMinutes(),
            d.getSeconds(),
            e.getDate(),
            (e.getMonth() + 1),
            e.getFullYear(),
            e.getHours(),
            e.getMinutes(),
            e.getSeconds()
            ];
            var i = 0;
            for (i=0; i<=11; i++) {
                if (bTime[i] < 10) {
                    bTime[i] = '0' + bTime[i].toString();
                }
            }
            
            //var startTime = bTime[0] + '/' + bTime[1] + '/' + bTime[2] + ' ' + bTime[3] + ':' +  bTime[4];
            var endTime = bTime[6] + '/' + bTime[7] + '/' + bTime[8] + ' ' + bTime[9] + ':' +  bTime[10];
            
            rangee+='<td class="duree">'+formate_duree_minutes(duration)+'</td>';
            rangee+='<td class="endTime">'+endTime+'</td>';
            rangee+='<td class="categorie">'+batiment.niveau+'</td>';
            rangee+='<td class="prerequis">'+((batiment.prerequis.niveau_cite>0)?batiment.prerequis.niveau_cite:'')+'</td>';
            rangee+='<td class="prerequis">'+prerequis+'</td>';
            rangee+='<td class="domination">'+formate_puissance(batiment.domination)+'</td>';
            rangee+='</tr>';
            $('#liste-batiments tbody').append(rangee);
            if(description)$('#liste-batiments tbody').append('<tr'+((nombre%2)?' class="impair"':'')+'><td colspan="12" class="description">'+batiment.description[_langue]+'</td><td colspan="2" class="prerequis"></td><td></td></tr>')
        }
        if(typeof filtre!='undefined'&&(filtre.faction!=''||filtre.categorie!='')){
            var lien='';
            if(typeof filtre.faction!='undefined'&&filtre.faction!='')lien+='/'+_factions[filtre.faction].nom[_langue];
            if(typeof filtre.categorie!='undefined'&&filtre.categorie!='')lien+='/'+_traduction.categorie[_langue]+'-'+_categories_batiments[filtre.categorie].nom[_langue]
        }
        var titre='<caption>'+nombre+' ';
        if (typeof lien!='undefined') {
            //titre+='<a href="'+_base_url+_page+lien+'">';
            titre+='';
        }
        titre+=_traduction.batiments[_langue];
        if(filtre!==undefined&&filtre.categorie!='')titre+=' '+_traduction.de_categorie[_langue]+' '+$('#filtre-categorie option:selected').text();
        if(filtre!==undefined&&filtre.faction!='')titre+=' '+_traduction.de_faction[_langue]+' '+$('#filtre-faction option:selected').text();
        if (typeof lien!='undefined') {
            //titre+='</a>';
            titre+='';
        }
        titre+='</caption>';
        $('#liste-batiments').prepend(titre);
        $('#liste-batiments').addClass('general');
        $('ul#choix-langue li a').each(function(id){
            var choix=$('ul#choix-langue li a').get(id);
            var langue_alt=$(choix).attr('hreflang');
            var re=new RegExp(_base_url+'([^/]+).*');
            var match=re.exec($(choix).attr('href'));
            var lien=_base_url+match[1];
            if(typeof _faction_id!='undefined'&&_faction_id)lien+='/'+_factions[_faction_id].nom[langue_alt];
            if(typeof _categorie_id!='undefined')lien+='/'+_traduction.categorie[langue_alt]+'-'+_categories_batiments[_categorie_id].nom[langue_alt];
            $(choix).attr('href',lien)
        })
    }

    
    
    function affiche_batiment(id){
        tri_batiments({
            id:true
        });
        var batiment=batiments[id-1];
        $('#liste-batiments').html(entete_tableau+'<tbody></tbody>');
        if(batiment!==undefined){
            if(batiment.nom[_langue]==='')var nom='~'+_traduction.nom_inconnu[_langue]+'~';else var nom=batiment.nom[_langue];
            if(batiment.faction==-1)var faction=_traduction.neutre[_langue];else var faction=_factions[batiment.faction].nom[_langue];
            if(batiment.prerequis.batiment===null)var prerequis='';else var prerequis=_batiments[batiment.prerequis.batiment].nom[_langue];
            var rangee='<tr id="batiment-'+batiment.id+'" class="impair">';
            //rangee+='<td class="nom"><a href="'+_base_url+_page+'/'+_factions[batiment.faction].nom[_langue]+'/'+nom+'">'+nom+'</a></td>';
            rangee+='<td class="nom">'+nom+'</td>';
            rangee+='<td class="faction">'+faction+'</td>';
            rangee+='<td class="categorie">'+_categories_batiments[batiment.categorie].nom[_langue]+'</td>';
            rangee+=affiche_cout_complet(batiment,modificateur_construction);
            rangee+='<td class="duree">'+formate_duree_minutes(Math.floor(batiment.duree*multiplicateur_duree*(1-(contremaitre/100))))+'</td>';
            rangee+='<td class="categorie">'+batiment.niveau+'</td>';
            rangee+='<td class="prerequis">'+((batiment.prerequis.niveau_cite>0)?batiment.prerequis.niveau_cite:'')+'</td>';
            rangee+='<td class="prerequis">'+prerequis+'</td>';
            rangee+='<td class="domination">'+formate_puissance(batiment.domination)+'</td>';
            rangee+='</tr>';
            $('#liste-batiments tbody').append(rangee);
            $('#liste-batiments tbody').append('<tr class="impair"><td colspan="12" class="description">'+batiment.description[_langue]+'</td><td colspan="2" class="prerequis"></td><td></td></tr>');
            $('ul#choix-langue li a').each(function(id){
                var choix=$('ul#choix-langue li a').get(id);
                var langue_alt=$(choix).attr('hreflang');
                var re=new RegExp(_base_url+'([^/]+).*');
                var match=re.exec($(choix).attr('href'));
                var base_lien=_base_url+match[1];
                var faction_lien=_factions[batiment.faction].nom[langue_alt];
                $(choix).attr('href',base_lien+'/'+faction_lien+'/'+batiment.nom[langue_alt])
            })
        }else{
            $('#liste-batiments').append('<tr><td colspan="15">'+_traduction.id_batiment_incorrect[_langue]+'</td></tr>')
        }
    }
    {

        var html='';
        var selected = '';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var f in _factions){
            selected = '';
            if (f == cookieGetValueByKey('faction')) {
                selected = 'selected = "selected"';
            }
            html+='<option value="'+f+'" '+selected+'>'+_factions[f].nom[_langue]+'</option>';
        }
        $('#filtre-faction').html(html);
        html='';
        html+='<option value="">'+_traduction.quelconque[_langue]+'</option>';
        for(var c in _categories_batiments){
            selected = '';
            if (c == cookieGetValueByKey('categorie')) {
                selected = 'selected = "selected"';
            }
            html+='<option value="'+c+'" '+selected+'>'+_categories_batiments[c].nom[_langue]+'</option>'
        }
        $('#filtre-categorie').html(html);
        $('input[type=checkbox]').removeAttr('checked');
        $('#conteneur form').submit(function(){
            return false
        })
    }
    $('#javascript-desactive').addClass('cache');
    $('#conteneur').removeClass('cache');
    $('#version').html('version '+_version.v+' ('+_version.date+')');
    function filtre_batiments(){
        var filtre={};
        var tri={};
        filtre.faction=$('#filtre-faction').val();
        filtre.categorie=$('#filtre-categorie').val();
        tri.faction=($('#tri-faction').attr('checked'));
        tri.categorie=($('#tri-categorie').attr('checked'));
        tri.domination=($('#tri-domination').attr('checked'));
        tri.duree=($('#tri-duree').attr('checked'));
        tri.cout=($('#tri-cout').attr('checked'));
        tri.nom=($('#tri-nom').attr('checked'));
        if($('#affichage-description').attr('checked'))description=true;else description=false;
        liste_batiments(filtre,tri)
    }
    $('#filtrer,#ordonner,#asp_start_time_ok').click(function(){
        filtre_batiments()
    });
    $('select,input[type=checkbox]').bind('change keyup',function(){
        cout_rare = parseInt($('#cout-ressource-rare').val());
        cout_commune = cout_rare/2;

        var cookieData = cookieGetValueByKey();
        cookieData.construction = parseInt($('#modificateur-construction').val(),10);
        cookieData.foreman = parseInt($('#contremaitre').val(),10);
        $.cookie('jactari_cookie', JSON.stringify(cookieData), {
            expires: 30,
            path: '/'
        });
        if (typeof cookieGetValueByKey('construction') == 'number') {
            modificateur_construction = parseInt(cookieGetValueByKey('construction'),10);
        } else {
            modificateur_construction = parseInt($('#modificateur-construction').val(),10);
        }
        if (typeof cookieGetValueByKey('foreman') == 'number') {
            contremaitre = parseInt(cookieGetValueByKey('foreman'),10);
        } else {
            contremaitre = parseInt($('#contremaitre').val(),10);
        }
        
        
        switch(modificateur_construction){
            case 1:
                multiplicateur_cout=1.4;
                multiplicateur_duree=0.8;
                break;
            case-1:
                multiplicateur_cout=0.8;
                multiplicateur_duree=1.6;
                break;
            case 0:default:
                multiplicateur_cout=1;
                multiplicateur_duree=1;
                break
        }
        
        if(typeof id!='undefined'&&id!==false)affiche_batiment(id);else filtre_batiments()
    });
    var description=false;
    $('#cout-ressource-rare').val(1000);
    var cout_rare=1000;
    var cout_commune=500;

    if (typeof cookieGetValueByKey('construction') == 'number') {
        $('#modificateur-construction').val(parseInt(cookieGetValueByKey('construction'),10));
    }
    var modificateur_construction = parseInt($('#modificateur-construction').val(),10);
    switch(modificateur_construction){
        case 1:
            multiplicateur_cout=1.4;
            multiplicateur_duree=0.8;
            break;
        case-1:
            multiplicateur_cout=0.8;
            multiplicateur_duree=1.6;
            break;
        case 0:default:
            multiplicateur_cout=1;
            multiplicateur_duree=1;
            break
    }
    if (typeof cookieGetValueByKey('foreman') == 'number') {
        $('#contremaitre').val(parseInt(cookieGetValueByKey('foreman'),10));
    }
    var contremaitre = parseInt($('#contremaitre').val(),10);
    var entete_tableau='<thead><tr><th rowspan="2">'+toCapitalCase(_traduction.nom[_langue])+'</th>'+'<th rowspan="2">'+toCapitalCase(_traduction.faction[_langue])+'</th>'+'<th rowspan="2">'+toCapitalCase(_traduction.categorie[_langue])+'</th>'+'<th colspan="7" rowspan="2">'+toCapitalCase(_traduction.cout[_langue])+'</th>'+'<th rowspan="2">'+toCapitalCase(_traduction.duree[_langue])+'<th rowspan="2" style="width: 150px;">'+toCapitalCase(_traduction.echeance[_langue])+'</th><th rowspan="2">'+toCapitalCase(_traduction.niveau[_langue])+'</th>'+'<th colspan="2" class="prerequis">'+toCapitalCase(_traduction.prerequis[_langue])+'</th>'+'<th rowspan="2">'+toCapitalCase(_traduction.domination[_langue])+'</th></tr>'+'<tr><th class="prerequis">'+toCapitalCase(_traduction.cite[_langue])+'</th><th class="prerequis">'+toCapitalCase(_traduction.batiment[_langue])+'</th></tr>';
    var batiments=[];
    for(var u in _batiments)if(u>0){
        batiments[u]={
            id:u,
            nom:{
                fr:_batiments[u].nom.fr,
                en:_batiments[u].nom.en,
                de:_batiments[u].nom.de,
                ru:_batiments[u].nom.ru
            },
            categorie:_batiments[u].categorie,
            faction:_batiments[u].faction,
            duree:_batiments[u].duree,
            niveau:_batiments[u].niveau,
            domination:_batiments[u].domination,
            cout:{},
            prerequis:{
                niveau_cite:_batiments[u].prerequis.niveau_cite,
                batiment:_batiments[u].prerequis.batiment
            },
            description:{
                fr:_batiments[u].description.fr,
                en:_batiments[u].description.en,
                de:_batiments[u].description.de,
                ru:_batiments[u].description.ru
            }
        };

        for(var r in _ressources){
            if(_batiments[u].cout[r]!==undefined)batiments[u].cout[r]=_batiments[u].cout[r]
        }
    }

    var get=document.location.search;
    var pos=get.indexOf('id=');
    if(pos!=-1){
        var id=get.substr(pos+3);
        affiche_batiment(id)
    }else if(_faction!==null&&_batiment!==null){
        var f=cherche_faction(_faction);
        if(f!==false){
            var id=cherche_batiment(_batiment,f);
            if(id!==false)affiche_batiment(id);else $('#conteneur').append(_traduction.batiment_inconnu[_langue])
        }else{
            $('#conteneur').append(_traduction.faction_inconnue[_langue])
        }
    }else if(_categorie!==null||_faction!==null){
        var filtre={
            faction:'',
            categorie:''
        };

        if(_categorie!==null){
            var _categorie_id=cherche_categorie(_categorie);
            filtre.categorie=_categorie_id;
            $('#filtre-categorie').val(_categorie_id)
        }
        if(_faction!==null){
            var _faction_id=cherche_faction(_faction);
            filtre.faction=_faction_id;
            $('#filtre-faction').val(_faction_id)
        }
        liste_batiments(filtre)
    }else{
        liste_batiments()
    }
    $.preloadImages(_images)
});